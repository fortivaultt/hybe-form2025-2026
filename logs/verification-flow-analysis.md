# Verification Flow and Token Handling Analysis

This document outlines the end-to-end user verification flow, including OTP format and token handling.

## 1. OTP Format

- **Type:** 6-digit numeric code.
- **Source:** Generated by Supabase Auth.
- **Frontend Implementation:**
  - The input field in `index.html` (`id="otp-input"`) is configured for a 6-digit numeric code:
    - `maxlength="6"`
    - `pattern="[0-9]{6}"`
    - `inputmode="numeric"`
  - The `script.js` file also validates that the input is a 6-digit string before sending it for verification.

## 2. Token Handling and Verification Flow

The entire verification process is handled client-side within a modal, without requiring the user to leave the page.

1.  **Initiation:**
    - The user clicks the "Send Verification Code" button (`id="send-otp-btn"`) in the email verification modal.
    - `script.js` calls the `sendEmailOtp(email, window.location.origin)` function from `lib/supabaseClient.js`.
    - **Note:** Although `emailRedirectTo` is set to the site's origin, the primary UI flow does not rely on the user clicking a link in the email and being redirected. The user is expected to retrieve the code from the email and enter it manually.

2.  **User Input:**
    - The user receives the 6-digit OTP in their email and enters it into the `otp-input` field in the modal.

3.  **Verification:**
    - When the user enters 6 digits or clicks the "Verify Code" button (`id="verify-otp-btn"`), the `verifyOtp()` function in `script.js` is triggered.
    - This function retrieves the email address and the 6-digit OTP (the "token") from the client-side state and input field.
    - It then calls the `verifyEmailOtp(email, token)` function from `lib/supabaseClient.js`.

4.  **Supabase Call:**
    - `verifyEmailOtp` calls `client.auth.verifyOtp({ email, token, type: 'email' })`.
    - **Critical Issue:** As noted in the email provider analysis, the `type: 'email'` parameter is likely incorrect for this flow and should be `type: 'magiclink'`.

5.  **Post-Verification:**
    - **Success:** If the verification is successful, the `emailVerificationState.isVerified` flag is set to `true`, a success toast is shown, the modal is closed, and the form submission is enabled and automatically resumed if it was pending.
    - **Failure:** If verification fails, an error toast is displayed with a message from Supabase (e.g., "Invalid or expired verification code"), and the OTP input field is marked as invalid.

## 3. Conclusion

- The flow is designed to be seamless and happens entirely on the client side without a page reload.
- The "token" in this context is the 6-digit OTP code itself.
- The primary point of failure in this flow is the incorrect `type` parameter used in the `verifyOtp` call to Supabase, which is a high-severity bug.
